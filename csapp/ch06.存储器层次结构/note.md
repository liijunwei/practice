20220815

+ 作为一个程序员, 你要理解存储器层次结构, 因为它对应用程序性能有着巨大的影响
    + CPU 寄存器 -> 指令执行期间, 0个周期内能访问到(???)
    + 高速缓存 -> 4-75周期
    + 主存中 -> 上百周期
    + 磁盘上 -> 几千万个周期

+ 如果你理解了系统时如何将数据在存储器层侧结构中上上下下移动的, 那么你就可以编写自己的应用程序, 使得他们的数据项存储在层次结构中较高的地方, 在那里CPU能更快地访问到他们

+ 计算机程序的 "局部性(locality)"的基本属性
    + 具有良好局部性的程序倾向于一次又一次地访问相同的数据项集合, 或是倾向于访问临近的数据项集合
    + 具有良好局部性的程序比局部性差的程序更多地倾向于从存储器层次结构中较高层次处访问数据项, 因此运行的更快

+ 本章
    + 基本的存储技术: SRAM/DRAM/ROM存储器 一级 旋转的和固态的硬盘
    + 描述他们是如何被组织称层次结构的
    + 主要精力集中在高速缓存存储器上, 他们是CPU和主存之间的缓存区域, 他们对程序性能的影响最大
    + 如何分析C程序的局部性, 介绍改进你的程序中局部性的技术
    + 描绘某台机器上存储器层次的性能的有趣方法, 成为"存储器山memory mountain", 他展示出度访问时间也是局部性的一个函数

# 6.1 存储技术

## 6.1.1 随机访问存储器

+ Random-Access Memory, RAM 分两类
    + 静态的 SRAM(Static-RAM), 几 Mb
    + 动态的 DRAM(Dynamic-RAM), 几百/几千 Mb
    + SRAM 比 DRAM更快, 但也贵很多

+ 非易失性存储器
    + 如果断电, DRAM和SRAM会丢失他们的信息, 从这个意义上讲, 他们是一时的(volatile)
    + 另一方面, 非易失性存储器(nonvolatile memory) 即使在断电后, 仍然保存着他们的信息

+ 由于历史原因, 虽然ROM中有的类型既可以读也可以写, 但整体上他们都被称为只读存储器(Read-Only Memory, ROM)
+ ROM是以他们能够被重编程(写)的次数和对他们进行重编程所用的机制来区分的
    + PROM 可编程ROM
    + EPROM 可擦写的编程ROM
    + PROM 电子可擦写的编程ROM
    + 闪存(flash memory)
    + SSD 固态硬盘

+ 存储在ROM设备中的程序通常被称为固件
    + 一些系统在固件中提供了少量基本的输入/输出函数, 例如 PC的BIOS例程

+ 访问主存: 数据流通过成为总线(bus)的共享电子电路在处理器和DRAM主存之间来来回回
    + 总线是一组并行的导线, 能携带地址/数据和控制信号
    + 总线事务(bus transaction)
    + 读事务: 从主存传送数据到CPU
    + 写事务: 从CPU传送数据到主存

+ 示例计算机系统
    + CPU芯片
    + IO桥接器(芯片组)
    + DRAM内存模块
    +
    + 由一对总线连接起来

+ 系统总线(system bus) 连接 CPU芯片 和 IO桥接器
+ 内存总线(memory bus) 连接 IO桥接器 和 DRAM内存模块

## 6.1.2 磁盘存储

+ 从磁盘上读信息的时间为毫秒级, 比DRAM慢了10万倍, 比SRAM慢了100万倍

+ 磁盘构造 相关概念
    + 盘片(platter)
    + 表面(surface)
    + 磁性记录材料
    + 主轴(spindle)
    + 磁道(track)
    + 扇区(sector)
    + 圆柱面(cylinder)

+ 问题: 扇区/柱面 的概念 和 磁盘存储有什么关系?

## 6.1.4 存储技术趋势

+ 现代计算机频繁地使用基于SRAM的高速缓存, 试图弥补处理器-内存之间的差距. 这种方法行之有效是因为 应用程序的一个称为"局部性"(locality) 的基本属性

+ 多核处理器

# 6.2 局部性

+ 一个编写良好的计算机程序具有良好的局部性(locality). 也就是 他们倾向于引用邻近与其他最近引用过的数据项的数据项, 或者最近引用过的数据项本身
+ 这种倾向性, 被称为 "局部性原理"(principle of locality), 它是一个持久的概念, 对硬件和软件系统的设计和性能都有着极大的影响

+ 局部性通常有两种不同的形式:
    + 时间局部性(temporal locality): 被引用过一次的内存位置很可能在不远的将来再被多次引用
    + 空间局部性(spatial locality): 如果一个内存位置被引用了一次, 那么程序很可能在不远的将来引用附近的一个内存位置

+ 程序员应该理解局部性原理, 因为一般而言, 有良好的局部性的程序比局部性差的程序运行的更快

+ 实例
    + 硬件层, 高速缓存存储器 -> CPU
    + 操作系统层: 使用主存作为虚拟地址空间最近被引用块的高速缓存
    + 操作系统层: 用主存缓存磁盘文件系统中最近被使用的磁盘块
    + web浏览器: 将最近被引用的文档放在本地缓存里, 利用时间局部性


## 6.2.3 局部性小节

+ 量化评价程序中局部性的一些简单原则
    + 重复引用相同变量的程序有良好的时间局部性
    + 对于具有补偿为k的引用模式程序, 步长越小, 空间局部性越好
    + 对于取指令来说, 循环有好的时间和空间局部性; 循环体越小, 循环迭代次数越多, 局部性越好

+ 问题: 为什么 有良好局部性的程序 比 局部性差的程序运行的更快?

+ 了解如何看一眼源代码就能获得对程序中局部性的高层次的认识, 是程序员要掌握的一项有用且重要的技能




























